name: Laravel Production Deploy

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Production
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script_timeout: 15m
          script: |
            set -ex
            echo "=== Starting Deployment ==="

            # 1. Disk space check (fail if >90% used)
            echo "--- Disk Space Status ---"
            df -h
            if [ $(df --output=pcent / | tail -1 | tr -dc '0-9') -gt 90 ]; then
              echo "::error::Aborting: Disk space over 90% used"
              exit 1
            fi

            # 2. Atomic deployment process
            echo "--- Syncing Files ---"
            mkdir -p ~/laravel-app-new
            rsync -az --delete \
              --exclude=.git \
              --exclude=node_modules \
              --exclude=vendor \
              --exclude=storage \
              --exclude=bootstrap/cache \
              --exclude=.env \
              $GITHUB_WORKSPACE/ ~/laravel-app-new/

            # 3. Prepare production
            echo "--- Preparing Production ---"
            chmod -R 755 ~/laravel-app-new/storage
            chmod -R 755 ~/laravel-app-new/bootstrap/cache

            # 4. Docker operations
            echo "--- Starting Containers ---"
            cd ~/laravel-app-new
            docker compose down || true
            docker compose build --no-cache
            docker compose up -d

            # 5. Atomic switch
            echo "--- Finalizing Deployment ---"
            rm -rf ~/laravel-app-old
            mv ~/laravel-app ~/laravel-app-old || true
            mv ~/laravel-app-new ~/laravel-app

            # 6. Cleanup
            docker system prune -f || true
            rm -rf ~/laravel-app-old || true

            echo "=== Deployment Successful ==="
            echo "--- Final Disk Usage ---"
            df -h
