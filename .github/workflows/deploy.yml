name: Laravel Production Deploy

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install rsync
        run: sudo apt-get update && sudo apt-get install -y rsync

      - name: Deploy to Production
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            set -ex
            echo "=== Starting Deployment ==="

            # 1. Disk space check
            echo "--- Disk Space Status ---"
            df -h
            if [ $(df --output=pcent / | tail -1 | tr -dc '0-9') -gt 90 ]; then
              echo "::error::Aborting: Disk space over 90% used"
              exit 1
            fi

            # 2. Prepare directory structure
            echo "--- Preparing Directory ---"
            mkdir -p ~/laravel-app-new
            cd ~/laravel-app-new

            # 3. Sync only necessary files (from GitHub workspace root)
            echo "--- Syncing Files ---"
            rsync -az --delete \
              --exclude=.git \
              --exclude=node_modules \
              --exclude=vendor \
              --exclude=storage \
              --exclude=bootstrap/cache \
              --exclude=.env \
              --exclude=docker \
              $GITHUB_WORKSPACE/ .

            # 4. Set proper permissions
            echo "--- Setting Permissions ---"
            chmod -R 755 storage
            chmod -R 755 bootstrap/cache

            # 5. Docker operations
            echo "--- Starting Containers ---"
            docker compose down || true
            docker compose build --no-cache
            docker compose up -d

            # 6. Atomic switch
            echo "--- Finalizing Deployment ---"
            cd ~
            rm -rf ~/laravel-app-old
            mv ~/laravel-app ~/laravel-app-old || true
            mv ~/laravel-app-new ~/laravel-app

            # 7. Cleanup
            echo "--- Cleaning Up ---"
            docker system prune -f || true
            rm -rf ~/laravel-app-old || true

            echo "=== Deployment Successful ==="
            echo "--- Final Disk Usage ---"
            df -h
