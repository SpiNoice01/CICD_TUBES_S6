name: Deploy Laravel to Azure VM

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install npm dependencies
        run: npm install

      - name: Build assets
        run: npm run build

      - name: Setup SSH
        shell: bash
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "Host *" > ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config

      - name: Deploy Application via rsync
        shell: bash
        run: |
          rsync -avz --no-perms --no-owner --no-group --delete \
            -e "ssh -o StrictHostKeyChecking=no" \
            --exclude='.git' \
            --exclude='.env' \
            --exclude='storage/*' \
            --exclude='node_modules' \
            ./ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/laravel-app/

      - name: Remote Setup & Deploy
        shell: bash
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            set -e
            sudo apt-get update
            sudo apt-get install -y nginx php8.2-fpm php-sqlite3 unzip curl
            cd ~/laravel-app
            sudo chown -R $USER:www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache
            if [ ! -f .env ]; then
              cp .env.example .env
              php artisan key:generate
            fi
            composer install --optimize-autoloader --no-dev
            php artisan migrate --force
            sudo tee /etc/nginx/sites-available/laravel << 'NGINX_CONF'
            server {
                listen 80;
                server_name _;
                root /home/${USER}/laravel-app/public;

                index index.php index.html index.htm;

                location / {
                    try_files $uri $uri/ /index.php?$query_string;
                }

                location ~ \.php$ {
                    include snippets/fastcgi-php.conf;
                    fastcgi_pass unix:/run/php/php8.2-fpm.sock;
                }

                location ~ /\.ht {
                    deny all;
                }
            }
            NGINX_CONF
            sudo ln -sf /etc/nginx/sites-available/laravel /etc/nginx/sites-enabled/
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo systemctl restart nginx
            sudo systemctl restart php8.2-fpm
          EOF

      - name: Verify Deployment
        run: |
          curl -sSf http://${{ secrets.SSH_HOST }} || (echo "❌ Website is not accessible!" && exit 1)
