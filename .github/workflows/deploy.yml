name: Laravel Production Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install rsync
        run: sudo apt-get update && sudo apt-get install -y rsync

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            set -ex
            echo "=== Starting Deployment ==="

            # 1. Prepare directory
            mkdir -p ~/laravel-app
            cd ~/laravel-app

            # 2. Sync files (exclude development files)
            echo "Syncing files..."
            rsync -az --delete \
              --exclude=.git \
              --exclude=node_modules \
              --exclude=vendor \
              --exclude=storage \
              --exclude=bootstrap/cache \
              --exclude=.env \
              $GITHUB_WORKSPACE/ .

            # 3. Set permissions
            chmod -R 775 storage bootstrap/cache

            # 4. Docker operations
            echo "Starting containers..."
            docker compose down || true
            docker compose build --no-cache
            docker compose up -d

            # 5. Install dependencies inside container
            docker exec laravel-app composer install --no-interaction
            docker exec laravel-app npm install --production
            docker exec laravel-app npm run build

            echo "=== Deployment Successful ==="
