name: Laravel Production Deploy

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Production
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            set -e
            echo "=== Starting Deployment ==="

            # 1. Check disk space first
            df -h
            if [ $(df --output=pcent / | tail -1 | tr -dc '0-9') -gt 90 ]; then
              echo "::error::Disk space is critically low!"
              exit 1
            fi

            # 2. Clean previous deployment
            rm -rf ~/laravel-app-temp
            mkdir -p ~/laravel-app-temp

            # 3. Precise rsync with proper source path
            rsync -az --delete \
              --exclude=.git \
              --exclude=node_modules \
              --exclude=vendor \
              --exclude=storage \
              --exclude=bootstrap/cache \
              --exclude=.env \
              $GITHUB_WORKSPACE/ ~/laravel-app-temp/

            # 4. Swap directories atomically
            rm -rf ~/laravel-app-old
            mv ~/laravel-app ~/laravel-app-old || true
            mv ~/laravel-app-temp ~/laravel-app

            # 5. Set permissions
            chmod -R 755 ~/laravel-app/storage
            chmod -R 755 ~/laravel-app/bootstrap/cache

            # 6. Docker operations
            cd ~/laravel-app
            docker compose down || true
            docker compose build --no-cache
            docker compose up -d

            # 7. Cleanup
            rm -rf ~/laravel-app-old

            echo "=== Deployment Complete ==="
